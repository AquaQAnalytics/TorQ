action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,.stplg.multilog:`custom,1,,"Set custom logging mode"
before,0,0,q,".stplg.custommode:1_(!) . (""SS"";"","")0: .stplg.customcsv",1,,"Load custom settings"
before,0,0,q,delete from `.stpm.metatable,1,,"Clear meta table"
before,0,0,q,.stplg.init[dbname],1,,"Initialise stp script"
before,0,0,q,.stplg.t:.stplg.t except `KUT`KUTR,1,,"Remove k4 tables from log table"
before,0,0,q,testtrade:(10?`4;10?100.0;10?100i;10#0b;10?.Q.A;10?.Q.A;10#`buy),1,,"Create test trade update"
before,0,0,q,testquote:(10?`4;10?100.0;10?100.0;10?100i;10?100i;10?.Q.A;10?.Q.A;10#`3),1,,"Create
test quote update"
true,0,0,q,currlog[`trade;`logname]~first exec logname from .stpm.metatable where `trade in/: tbls,1,,"Check logname saved to meta table"
true,0,0,q,currlog[`quote;`logname]~first exec logname from .stpm.metatable where `quote in/: tbls,1,,"Check logname saved to meta table"
true,0,0,q,currlog[`heartbeat;`logname]~first exec logname from .stpm.metatable where `heartbeat in/: tbls,1,,"Check logname saved to meta table"
true,0,0,q,(0#trade)~first (exec schema from .stpm.metatable where `trade in/: tbls)[`trade],1,,"Check schema saved to meta table"
true,0,0,q,(0#quote)~first (exec schema from .stpm.metatable where `quote in/: tbls)[`quote],1,,"Check schema saved to meta table"
true,0,0,q,all 0=.stpm.metatable[`msgcount],1,,"Check no records listed in log"
true,0,0,q,`trade`trade_iex in .stpm.metatable[`tbls],1,,"Check both trade tables saved to single meta record"
true,0,0,q,`quote in .stpm.metatable[`tbls],1,,"Check quote tables saved to separate meta records"
true,0,0,q,`heartbeat in .stpm.metatable[`tbls],1,,"Check heartbeat saved to separate meta records"
true,0,0,q,not any `logmsg in/: .stpm.metatable[`tbls],1,,"Check logmsg not in meta records"
true,0,0,q,1<count .stpm.metatable,1,,"Check multiple meta records
true,0,0,q,all ("v"$.z.p+.eodtime.dailyadj)="v"$.stpm.metatable[`start],1,,"Check correct start time listed for log"
true,0,0,q,all null .stpm.metatable[`end],1,,"Check no end time listed for log"
run,0,0,q,.u.upd[`trade;testtrade],1,,"Run trade update"
run,0,0,q,.u.upd[`quote;testquote],1,,"Run quote update"
run,0,0,q,.stplg.endofperiod[.z.p+.eodtime.dailyadj],1,,"Roll logs"
run,0,0,q,"tabmeta:select from .stpm.metatable where seq=0",1,,"Save initial meta records"
run,0,0,q,"tabmeta2:select from .stpm.metatable where seq=1",1,,"Save new meta records"
true,0,0,q,`trade`trade_iex in tabmeta[`tbls],1,,"Check both trade tables saved to single meta record"
true,0,0,q,`quote in tabmeta[`tbls],1,,"Check quote tables saved to separate meta records"
true,0,0,q,`trade`trade_iex in tabmeta2[`tbls],1,,"Check new meta for trade tables"
true,0,0,q,not `quote in tabmeta2[`tbls],1,,"Check quote tables not rolled"
true,0,0,q,1=first exec msgcount from tabmeta where `trade in/: tbls,1,,"Check records meta updated"
true,0,0,q,0=first exec msgcount from tabmeta where `quote in/: tbls,1,,"Check records meta updated"
true,0,0,q,all not null (select from tabmeta where (not `quote in/: tbls) and not `quote_iex in/: tbls)`end,1,,"Check end time updated"
after,0,0,q,.z.ts[],1,,"Clear tables"
after,0,0,q,"system""rm -r "",1_string[.stplg.dldir]",1,,"Clear log directory"
after,0,0,q,"delete tabmeta,tabmeta2 from `.",1,,"Remove meta tables"
