action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,.u.sub[;enlist `IBM]each .stpps.t,1,,"Replicate client subscription to list of syms"
before,0,0,q,"testtrade:((5#`IBM),5?`4;10?100.0;10?100i;10#0b;10?.Q.A;10?.Q.A;10#`buy)",1,,"Create test trade update"
before,0,0,q,"testquote:(10?`4;(5?50.0),50+5?50.0;10?100.0;10?100i;10?100i;10?.Q.A;10?.Q.A;10#`3)",1,,"Create test quote update"
before,0,0,q,.stplg.t:.stplg.t except `KUT`KUTR,1,,"Remove k4 tables from log table"
before,0,0,q,"system""t 0""",1,,"Turn off automatic publish"
before,0,0,q,init[`defaultbatch],1,,"Define timer and update functions"
before,0,0,q,.u.upd[`trade;testtrade],1,,"Run trade update"
before,0,0,q,.u.upd[`quote;testquote],1,,"Run quote update"
before,0,0,q,.tst.h:hopen 100+"I"$getenv[`KDBBASEPORT],1,,"Open handle to dummy client"
before,0,0,q,.tst.t:.tst.h"count trade",1,,"Save number of records in client table"
before,0,0,q,.tst.q:.tst.h"count quote",1,,"Save number of records in client table"
true,0,0,q,all 0=count each .stpps.subrequestall,1,,"Check no subscriptions for all data"
true,0,0,q,all .stpps.t in exec tbl from .stpps.subrequestfiltered,1,,"Check rdb subscribed to all tables"
run,0,0,q,update handle:.tst.h from `.stpps.subrequestfiltered,1,,"Re-assign client handles to dummy"
run,0,0,q,.stpps.closesub .z.w,1,,"Remove .z.w handles"
true,0,0,q,10~count trade,1,,"Check trade update applied"
true,0,0,q,10~count quote,1,,"Check quote update applied"
run,0,0,q,.z.ts[],1,,"Publish updates"
true,0,0,q,0~count trade,1,,"Check trade update published"
true,0,0,q,(.tst.t+5)~.tst.h"count trade",1,,"Check filtered trade data published"
true,0,0,q,"all`IBM=exec distinct sym from -5#.tst.h""trade""",1,,"Check filtered trade data published"
true,0,0,q,0~count quote,1,,"Check quote update published"
true,0,0,q,(.tst.q)~.tst.h"count quote",1,,"Check no quote data published"
run,0,0,q,.stpps.closesub .tst.h,1,,"Replicate client subscription closing"
true,0,0,q,0~count .stpps.subrequestfiltered,1,,"Check rdb subscription closed"
