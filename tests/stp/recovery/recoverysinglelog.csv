action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,startproc["stpnone"],1,,"Start STP"
before,0,0,q,.servers.startup[],1,,"Set up connection management"
before,0,0,q,.proc.sys "sleep 2",1,,"Wait for proc to start"
before,0,0,q,stpHandle:gethandle[`stpnone],1,,"Open STP handle"
before,0,0,q,tst1:stpHandle"subdetails[`;`]",1,,"TST"
before,0,0,q,stpHandle(setenv;`KDBSTPLOG;stptestlogs),1,,"Change location of segmented tickerplant logs"
before,0,0,q,tst2:stpHandle"subdetails[`;`]",1,,"TST"
before,0,0,q,.proc.sys "sleep 2",1,,"Wait for connections to get set up"
before,0,0,q,startproc each ("rdball";"rdbsymfilt";"rdbcomplexfilt"),1,,"Start all procs"
before,0,0,q,tst3:stpHandle"subdetails[`;`]",1,,"TST"
before,0,0,q,.proc.sys "sleep 2",1,,"Wait for procs to start"
before,0,0,q,rdbHandles:`all`sym`complex!gethandle each `rdball`rdbsymfilt`rdbcomplexfilt,1,,"Open RDB handles"
before,0,0,q,stpHandle".stplg.init[\"testlogsnone\"]",1,,"Create test stplog directory corresponding to mulitlog setting"
before,0,0,q,t1:(value rdbHandles) @\: "count trade",1,,"Get initial trade table counts"
before,0,0,q,q1:(value rdbHandles) @\: "count quote",1,,"Get initial quote table counts"
run,0,0,q,"stpHandle @/: `.u.upd ,/: ((`trade;testtrade);(`quote;testquote))",1,,"Send trade and quote updates to STP"
run,0,0,q,.proc.sys "sleep 2",1,,"Wait for updates to publish"
true,0,0,q,(t1+10 5 5)~t2:(value rdbHandles) @\: "count trade",1,,"Check trade update was correctly published"
true,0,0,q,(q1+10 0 5)~q2:(value rdbHandles) @\: "count quote",1,,"Check quote update was correctly published"
true,0,0,q,all raze `GOOG=rdbHandles[`sym`complex] @\: "exec distinct sym from trade",1,,"Check correct sym filters were applied"
true,0,0,q,all 50<rdbHandles[`complex] "exec bid from quote",1,,"Check complex filters were applied"
run,0,0,q,kill9proc each ("rdball";"rdbsymfilt";"rdbcomplexfilt"),1,,"Stop all RDBs"
run,0,0,q,.z.pc each value rdbHandles,1,,"Close all RDB handles"
run,0,0,q,.proc.sys "sleep 5",1,,"Wait for procs to die"
true,0,0,q,all not isalive each ("rdball";"rdbsymfilt";"rdbcomplexfilt"),1,,"Check RDBs are dead"
run,0,0,q,startproc each ("rdball";"rdbsymfilt";"rdbcomplexfilt"),1,,"Start all RDBs again"
run,0,0,q,.proc.sys "sleep 2",1,,"Wait for procs to come back up"
run,0,0,q,rdbHandles:`all`sym`complex!gethandle each `rdball`rdbsymfilt`rdbcomplexfilt,1,,"Open RDB handles"
true,0,0,q,t2~(value rdbHandles) @\: "count trade",1,,"Check trade update was correctly replayed"
true,0,0,q,q2~(value rdbHandles) @\: "count quote",1,,"Check quote update was correctly replayed"
true,0,0,q,all raze `GOOG=rdbHandles[`sym`complex] @\: "exec distinct sym from trade",1,,"Check correct sym filters were applied"
true,0,0,q,all 50<rdbHandles[`complex] "exec bid from quote",1,,"Check complex filters were applied"
after,0,0,q,stpHandle(setenv;`KDBSTPLOG;stporiglogs),1,,"Change back STP log location"
after,0,0,q,kill9proc each ("stpnone";"rdball";"rdbsymfilt";"rdbcomplexfilt"),1,,"Stop all procs"
after,0,0,q,.os.deldir stptestlogs,1,,"Delete test segmented tickerplant logs"