action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,"system ""l "",getenv[`KDBTESTS],""/helperfunctions.q""",1,,"Make sure helper functions are loaded"
before,0,0,q,"stptestlogs:getenv[`KDBTESTS],""/stp/recovery/singlelog""",1,,"Path to test segmented tickerplant logs"
before,0,0,q,"processcsv:getenv[`KDBTESTS],""/stp/recovery/process.csv""",1,,"Path to test process csv"
before,0,0,q,startproc:startorstopproc["start";;processcsv],1,,"Function to start a process"
before,0,0,q,stopproc:startorstopproc["stop";;processcsv],1,,"Function to stop a process"
before,0,0,q,"testtrade:((5#`GOOG),5?`4;10?100.0;10?100i;10#0b;10?.Q.A;10?.Q.A;10#`buy)",1,,"Create test trade update"
before,0,0,q,startproc each ("rdball";"stprepperiod"),1,,"Start STP and RDB"
before,0,0,q,.proc.sys "sleep 1",1,,"Wait for procs to start up"
before,0,0,q,rdbHandle:opentorqhandle string 101+value getenv`KDBBASEPORT,1,,"Open handle to RDB"
before,0,0,q,stpHandle:opentorqhandle string 107+value getenv`KDBBASEPORT,1,,"Open handle to STP"
before,0,0,q,"stpHandle(setenv;`KDBSTPLOG;stptestlogs)",1,,"Change location of segmented tickerplant logs"
before,0,0,q,stpHandle".stplg.init[\"testlogsnone\"]",1,,"Create test stplog directory corresponding to mulitlog setting"
run,0,0,q,c1:rdbHandle"count trade",1,,"Get initial trade table count"
run,0,0,q,stpHandle(`.u.upd;`trade;testtrade),1,,"Send trade update to segmented tickerplant"
run,0,0,q,.proc.sys "sleep 11",1,,"Wait for 10 second period to elapse"
true,0,0,q,(c1+10)~c2:rdbHandle"count trade",1,,"Check update has published"
run,0,0,q,a:"q" in' b:@[system;"pgrep -lf rdball";`down],1,,"Get RDB PID info"
run,0,0,q,"system ""kill -9 "",first "" "" vs first b where a",1,,"Kill it"
true,0,0,q,not any "q" in' @[system;"pgrep -lf rdball";`down],1,,"Make sure it is dead"
run,0,0,q,startproc["rdball"],1,,"Restart RDB"
run,0,0,q,.proc.sys "sleep 1",1,,"Wait a sec"
run,0,0,q,rdbHandle:opentorqhandle string 101+value getenv`KDBBASEPORT,1,,"Open handle to RDB"
true,0,0,q,c1~rdbHandle"count trade",1,,"Check that table count is equal to initial count as the update shouldn't have replayed"
after,0,0,q,"stpHandle(setenv;`KDBSTPLOG;getenv[`TORQHOME],""/stplogs"")",1,,
after,0,0,q,stopproc each ("rdball";"stprepperiod"),1,,"Stop STP and RDB"
after,0,0,q,.os.deldir stptestlogs,1,,"Delete test segmented tickerplant logs"