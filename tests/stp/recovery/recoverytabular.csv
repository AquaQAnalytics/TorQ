action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,"stptestlogs:getenv[`KDBTESTS],""/stp/recovery/tabularlogs""",1,,"Path to test segmented tickerplant logs"
before,0,0,q,"processcsv:getenv[`KDBTESTS],""/stp/recovery/process.csv""",1,,"Path to test process"
before,0,0,q,startproc:startorstopproc["start";;processcsv],1,,"Function to start a process"
before,0,0,q,stopproc:startorstopproc["stop";;processcsv],1,,"Function to stop a process"
before,0,0,q,"testtrade1:((5#`GOOG),5?`4;10?100.0;10?100i;10#0b;10?.Q.A;10?.Q.A;10#`buy)",1,,"Create test trade update"
before,0,0,q,"testtrade2:((5#`GOOG),5?`4;10?100.0;10?100i;10#0b;10?.Q.A;10?.Q.A;10#`buy)",1,,"Create test trade update"
before,0,0,q,"testquote1:(10?`4;(5?50.0),50+5?50.0;10?100.0;10?100i;10?100i;10?.Q.A;10?.Q.A;10#`3)",1,,"Create test quote update"
before,0,0,q,"testquote2:(10?`4;(5?50.0),50+5?50.0;10?100.0;10?100i;10?100i;10?.Q.A;10?.Q.A;10#`3)",1,,"Create test quote update"
before,0,0,q,startproc["stptabular"],1,,"Start segmented tickerplant in tabular mode"
before,0,0,q,.proc.sys "sleep 2",1,,"Sleep for 2 seconds"
before,0,0,q,stptabularh:opentorqhandle string 105+value getenv`KDBBASEPORT,1,,"Open handle to segmented tickerplant"
before,0,0,q,"stptabularh(setenv;`KDBSTPLOG;stptestlogs)",1,,"Change location of segmented tickerplant logs"
before,0,0,q,stptabularh".stplg.init[\"testlogstabular\"]",1,,"Switch test stplog directory"
before,0,0,q,stptabularh(`.u.upd;`trade;testtrade1),1,,"Send first trade update to segmented tickerplant"
before,0,0,q,stptabularh(`.u.upd;`quote;testquote1),1,,"Send first quote update to segmented tickerplant"
before,0,0,q,stopproc["stptabular"],1,,"Stop the segmented tickerplant"
before,0,0,q,.proc.sys "sleep 2",1,,"Sleep for 2 seconds"
true,0,0,q,deadproccheck["stp";"stptabular"],1,,"Check segmented tickerplant is dead"
run,0,0,q,startproc["stptabular"],1,,"Start segmented tickerplant"
run,0,0,q,.proc.sys "sleep 2",1,,"Sleep for 2 seconds"
run,0,0,q,stptabularh:opentorqhandle string 105+value getenv`KDBBASEPORT,1,,"Open handle to segmented tickerplant"
run,0,0,q,"stptabularh(setenv;`KDBSTPLOG;stptestlogs)",1,,"Change location of segmented tickerplant logs"
run,0,0,q,stptabularh".stplg.init[\"testlogstabular\"]",1,,"Switch test stplog directory"
run,0,0,q,stptabularh(`.u.upd;`trade;testtrade2),1,,"Send second trade update to segmented tickerplant"
run,0,0,q,stptabularh(`.u.upd;`quote;testquote2),1,,"Send second quote update to segmented tickerplant"
run,0,0,q,startproc each ("rdball";"rdbsymfilt";"rdbcomplexfilt"),1,,"Start all rdbs"
run,0,0,q,.proc.sys "sleep 2",1,,"Sleep for 2 seconds"
run,0,0,q,rdballh:opentorqhandle string 101+value getenv`KDBBASEPORT,1,,"Open handle to rdball"
run,0,0,q,rdbsymh:opentorqhandle string 102+value getenv`KDBBASEPORT,1,,"Open handle to rdbsymfilt"
run,0,0,q,rdbcomplexh:opentorqhandle string 103+value getenv`KDBBASEPORT,1,,"Open handle to rdbcomplexfilt"
true,0,0,q,20~rdballh"count trade",1,,"Check trade update published in rdball"
true,0,0,q,20~rdballh"count quote",1,,"Check quote update published in rdball"
true,0,0,q,10~rdbsymh"count trade",1,,"Check trade update published in rdbsymfilt"
true,0,0,q,enlist[`GOOG]~rdbsymh"distinct exec sym from trade",1,,"Check trade update published in rdbsymfilt"
true,0,0,q,0~rdbsymh"count quote",1,,"Check quote update published in rdbsymfilt"
true,0,0,q,10~rdbcomplexh"count trade",1,,"Check trade update published in rdbcomplexfilt"
true,0,0,q,enlist[`GOOG]~rdbcomplexh"distinct exec sym from trade",1,,"Check trade update published in rdbcomplexfilt"
true,0,0,q,10~rdbcomplexh"count quote",1,,"Check quote update published in rdbcomplexfilt"
true,0,0,q,rdbcomplexh"all 50<exec bid from quote",1,,"Check quote update published in rdbcomplexfilt"
run,0,0,q,stopproc each ("rdball";"rdbsymfilt";"rdbcomplexfilt"),1,,"Stop all rdbs"
run,0,0,q,.proc.sys "sleep 2",1,,"Sleep for 2 seconds"
true,0,0,q,all deadproccheck["rdb";] each ("rdball";"rdbsymfilt";"rdbcomplexfilt"),1,,"Check all rdbs are dead"
run,0,0,q,startproc each ("rdball";"rdbsymfilt";"rdbcomplexfilt"),1,,"Start all rdbs"
run,0,0,q,.proc.sys "sleep 2",1,,"Sleep for 2 seconds"
run,0,0,q,rdballh:opentorqhandle string 101+value getenv`KDBBASEPORT,1,,"Open handle to rdball"
run,0,0,q,rdbsymh:opentorqhandle string 102+value getenv`KDBBASEPORT,1,,"Open handle to rdbsymfilt"
run,0,0,q,rdbcomplexh:opentorqhandle string 103+value getenv`KDBBASEPORT,1,,"Open handle to rdbcomplexfilt"
true,0,0,q,20~rdballh"count trade",1,,"Check trade data has correctly replayed in rdball"
true,0,0,q,20~rdballh"count quote",1,,"Check quote data has correctly replayed in rdball"
true,0,0,q,10~rdbsymh"count trade",1,,"Check trade data has correctly replayed in rdbsymfilt"
true,0,0,q,enlist[`GOOG]~rdbsymh"distinct exec sym from trade",1,,"Check trade data has correctly replayed in rdbsymfilt"
true,0,0,q,0~rdbsymh"count quote",1,,"Check quote data has correctly replayed in rdbsymfilt"
true,0,0,q,10~rdbcomplexh"count trade",1,,"Check trade data has correctly replayed in rdbcomplexfilt"
true,0,0,q,enlist[`GOOG]~rdbcomplexh"distinct exec sym from trade",1,,"Check trade data has correctly replayed in rdbcomplexfilt"
true,0,0,q,10~rdbcomplexh"count quote",1,,"Check quote data has correctly replayed in rdbcomplexfilt"
true,0,0,q,rdbcomplexh"all 50<exec bid from quote",1,,"Check quote data has correctly replayed in rdbcomplexfilt"
after,0,0,q,"stptabularh(setenv;`KDBSTPLOG;getenv[`TORQHOME],""/stplogs"")",1,,
after,0,0,q,stopproc["stptabular"],1,,"Stop segmented tickerplant"
after,0,0,q,stopproc each ("rdball";"rdbsymfilt";"rdbcomplexfilt"),1,,"Stop all rdbs"
after,0,0,q,.os.deldir stptestlogs,1,,"Delete test segmented tickerplant logs"
