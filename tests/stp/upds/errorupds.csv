action,ms,bytes,lang,code,repeat,minver,comment
beforeany,0,0,q,system "sleep 5",1,,"Wait for all procs to go up"
before,0,0,q,.servers.startup[],1,,"Get connection management set up"
before,0,0,q,system "sleep 2",1,,"Wait for all connections"
before,0,0,q,stpHandle:gethandle[`stp1],1,,"Get STP handle"
before,0,0,q,rdbHandle:gethandle[`rdb1],1,,"Get RDB handle"
before,0,0,q,"stpHandle""testTrade:(10?`4;10?100.0;10?100i;10#0b;10?.Q.A;10?.Q.A;10#`buy)"" ",1,,"Create test trade update"
before,0,0,q,"stpHandle"".stplg.updtab[`trade]: {(enlist(count first x)#(`long$1)),(enlist(count first x)#y),(enlist(count first x)#(`long$ .stplg.seqnum)),x}"" ",1,,"set unique upd definition for trade table to yield error"
before,0,0,q,stpHandle".stplg.errmode:1b",1,,"Ensure error mode is on in stp"
run,0,0,q,"stpHandle""init[`defaultbatch]"" ",1,,"Define timer and update functions"
run,0,0,q,"stpHandle"".u.upd[`trade;testTrade]"" ",1,,"Run trade update"
run,0,0,q,"stplogdata:get .Q.par[hsym `$getenv[`KDBSTPLOG];`$""testdatabase"", string .z.d;`$(last system""ls -R $KDBSTPLOG | grep err"")]",1,,"access latest error log file"
true,0,0,q,"1 ~ count stplogdata",1,,"one row in error log
run,0,0,q,"stpHandle""init[`memorybatch]"" ",1,,"Define timer and update functions"
run,0,0,q,"stpHandle"".u.upd[`trade;testTrade]"" ",1,,"Run trade update"
run,0,0,q,"stplogdata:get .Q.par[hsym `$getenv[`KDBSTPLOG];`$""testdatabase"", string .z.d;`$(last system""ls -R $KDBSTPLOG | grep err"")]",1,,"access latest error log file"
true,0,0,q,"2 ~ count stplogdata",1,,"two rows in error log
run,0,0,q,"stpHandle""init[`immediate]"" ",1,,"Define timer and update functions"
run,0,0,q,"stpHandle"".u.upd[`trade;testTrade]"" ",1,,"Run trade update"
run,0,0,q,"stplogdata:get .Q.par[hsym `$getenv[`KDBSTPLOG];`$""testdatabase"", string .z.d;`$(last system""ls -R $KDBSTPLOG | grep err"")]",1,,"access latest error log file"
true,0,0,q,"3 ~ count stplogdata",1,,"three row in error log
true,0,0,q,all `trade = stplogdata[;1],1,,"Check only errors for trade table"
true,0,0,q,all `upderr = stplogdata[;0],1,,"check all entries are errors"
true,0,0,q,all (count each stplogdata[;2]) <> rdbHandle"count cols trade",1,,"length of data is different to schema, time and seqnum are not being added"