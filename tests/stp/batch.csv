action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,.stplg.multilog:`tabperiod,1,,"Set default logging mode"
before,0,0,q,.stplg.init[dbname],1,,"Initialise stp script"
before,0,0,q,delete from `currlog where tbl in `KUT`KUTR,1,,"Remove k4 tables from log table"
before,0,0,q,.stplg.t:.stplg.t except `KUT`KUTR,1,,"Remove k4 tables from log table"
before,0,0,q,testtrade:(10?`4;10?100.0;10?100i;10#0b;10?.Q.A;10?.Q.A;10#`buy),1,,"Create test trade update"
before,0,0,q,testquote:(10?`4;10?100.0;10?100.0;10?100i;10?100i;10?.Q.A;10?.Q.A;10#`3),1,,"Create test quote update"
before,0,0,q,system"t 0",1,,"Turn off timer"
before,0,0,q,init[`memorybatch],1,,"Define batch timer and update functions in memorybatch mode"
before,0,0,q,traderep:0#trade,1,,"Create duplicate trade table to replay data into"
before,0,0,q,quoterep:0#quote,1,,"Create duplicate quote table to replay data into"
before,0,0,q,upd:{[t;x]if[t~`trade;`traderep insert x];if[t~`quote;`quoterep insert x]},1,,"Define replay function"
run,0,0,q,".u.upd[`trade`quote;enlist[testtrade],enlist[testquote]]",1,,"Run trade and quote update"
true,0,0,q,10~count trade,1,,"Check new records inserted"
run,0,0,q,-11!currlog[`trade;`logname],1,,"Replay trade log"
true,0,0,q,not (-10#traderep)~trade,1,,"Check disk write not run"
true,0,0,q,10~count quote,1,,"Check new records inserted"
run,0,0,q,-11!currlog[`quote;`logname],1,,"Replay quote log"
true,0,0,q,not (-10#quoterep)~quote,1,,"Check disk write not run"
run,0,0,q,.u.upd[`heartbeat;`batchtesterr],1,,"Send bad update"
run,0,0,q,trade2:trade,1,,"Save update"
run,0,0,q,quote2:quote,1,,"Save update"
run,0,0,q,.z.ts[],1,,"Publish batch, write to disk"
run,0,0,q,-11!currlog[`trade;`logname],1,,"Replay trade log"
true,0,0,q,(-10#traderep)~trade2,1,,"Check update written to correct log"
run,0,0,q,-11!currlog[`quote;`logname],1,,"Replay quote log"
true,0,0,q,(-10#quoterep)~quote2,1,,"Check update written to correct log"
after,0,0,q,"delete traderep,trade2 from `.",1,,"Remove duplicate trade table"
after,0,0,q,"delete quoterep,quote2 from `.",1,,"Remove duplicate quote table"
after,0,0,q,"system""rm -r "",1_string[.stplg.dldir]",1,,"Clear log directory"
