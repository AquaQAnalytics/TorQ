action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,testTrade:(10?`4;10?100.0;10?100i;10#0b;10?.Q.A;10?.Q.A;10#`buy),1,,"Create test trade update"
before,0,0,q,testQuote:(10?`4;10?100.0;10?100.0;10?100;10?100;10?.Q.A;10?.Q.A;10#`3),1,,"Create test quote update"
before,0,0,q,"system""t 0""",1,,"Turn off automatic publish"
before,0,0,q,init[`defaultbatch],1,,"Define timer and update functions"
before,0,0,q,subHandle:hopen 100+"I"$getenv[`KDBBASEPORT],1,,"Open handle to dummy client"
before,0,0,q,.u.sub[;`] each .stpps.t;.stpps.closesub .z.w,1,,"Replicate client subscription to all data"
before,0,0,q,"@[`.stpps.subrequestall;.stpps.t;,;subHandle]",1,,"Replace .z.w with client handle"
before,0,0,q,.u.upd[`trade;testTrade],1,,"Run trade update"
before,0,0,q,.u.upd[`quote;testQuote],1,,"Run quote update"
before,0,0,q,exTrade:update `g#sym from flip (1_cols trade)!testTrade,1,,"Create expected trade table"
before,0,0,q,exQuote:update `g#sym from flip (1_cols quote)!testQuote,1,,"Create expected quote table"
true,0,0,q,all 1=count each .stpps.subrequestall .stpps.t,1,,"Check only one client subscribed to all tables"
true,0,0,q,all subHandle=raze value .stpps.subrequestall,1,,"Check correct client subscribed to all tables"
true,0,0,q,0~count .stpps.subrequestfiltered,1,,"Check no filtered subscriptions"
true,0,0,q,exTrade~update `g#sym from delete time from trade,1,,"Check expected records are in local table"
true,0,0,q,exQuote~update `g#sym from delete time from quote,1,,"Check expected records are in local table"
run,0,0,q,.z.ts[],1,,"Publish updates"
true,0,0,q,exTrade~subHandle"delete time from trade",1,,"Check expected records are in client table"
true,0,0,q,exQuote~subHandle"delete time from quote",1,,"Check expected records are in client table"
run,0,0,q,.z.pc subHandle,1,,"Replicate client subscription closing"
true,0,0,q,not subHandle in raze value .stpps.subrequestall,1,,"Check client is unsubscribed"
run,0,0,q,subHandle"delete from `trade",1,,"Delete updated records"
run,0,0,q,subHandle"delete from `quote",1,,"Delete updated records"
after,0,0,q,hclose subHandle,1,,"Close handle to subscriber"