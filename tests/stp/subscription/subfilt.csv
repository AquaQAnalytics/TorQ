action,ms,bytes,lang,code,repeat,minver,comment
before,0,0,q,.u.sub[`trade;`GOOG`AMZN],1,,"Subscribe for sym-filtered trades"
before,0,0,q,.u.sub[`quote;1!flip `tabname`filts`columns!enlist each (`quote;`$"bid>50";`)],1,,"Subscribe for complex-filtered quotes"
before,0,0,q,subHandle:hopen 100+"I"$getenv[`KDBBASEPORT],1,,"Open handle to dummy client"
before,0,0,q,update handle:subHandle from `.stpps.subrequestfiltered,1,,"Change all handles to client handles"
before,0,0,q,testTrade:(10?`GOOG`MSFT`AAPL`AMZN;10?100.0;10?100i;10#0b;10?.Q.A;10?.Q.A;10#`buy),1,,"Create test trade update"
before,0,0,q,"testQuote:(10?`4;(5?50.0),50+5?50.0;10?100.0;10?100;10?100;10?.Q.A;10?.Q.A;10#`3)",1,,"Create test quote update"
before,0,0,q,exTrade:select from (flip (1_cols trade)!testTrade) where sym in `GOOG`AMZN,1,,"Create expected trade table"
before,0,0,q,exQuote:select from (flip (1_cols quote)!testQuote) where bid>50,1,,"Create expected quote table"
before,0,0,q,"system""t 0""",1,,"Turn off automatic publish"
before,0,0,q,init[`defaultbatch],1,,"Define timer and update functions"
before,0,0,q,.u.upd[`trade;testTrade],1,,"Run trade update"
before,0,0,q,.u.upd[`quote;testQuote],1,,"Run quote update"
true,0,0,q,all 0=count each .stpps.subrequestall,1,,"Check no 'all' subscriptions"
true,0,0,q,all `trade`quote in .stpps.subrequestfiltered[`tbl],1,,"Check trade and quote in filtered table"
true,0,0,q,0=count .stpps.subrequestfiltered[`tbl] except `trade`quote,1,,"Check nothing else in filtered table"
true,0,0,q,10~count trade,1,,"Check expected records are in local table"
true,0,0,q,10~count quote,1,,"Check expected records are in local table"
run,0,0,q,.z.ts[],1,,"Publish updates"
true,0,0,q,exTrade~subHandle"delete time from trade",1,,"Check expected records are in client table"
true,0,0,q,exQuote~subHandle"delete time from quote",1,,"Check expected records are in client table"
run,0,0,q,.z.pc subHandle,1,,"Replicate client subscription closing"
true,0,0,q,not subHandle in exec handle from .stpps.subrequestfiltered,1,,"Check client is unsubscribed"
run,0,0,q,subHandle"delete from `trade",1,,"Delete updated records"
run,0,0,q,subHandle"delete from `quote",1,,"Delete updated records"
after,0,0,q,hclose subHandle,1,,"Close handle to subscriber"
