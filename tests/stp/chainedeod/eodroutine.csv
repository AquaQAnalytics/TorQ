action,ms,bytes,lang,code,repeat,minver,comment
beforeany,0,0,q,system "sleep 5",1,,"Wait for all procs to go up"
before,0,0,q,.servers.startup[],1,,"Get connection management set up"
before,0,0,q,system "sleep 2",1,,"Wait for all connections"
before,0,0,q,stpHandle:gethandle[`stp1],1,,"Get STP handle"
before,0,0,q,sctpHandle:gethandle[`sctp1],1,,"Get SCTP handle"
before,0,0,q,sctpHandle".sctp.loggingmode:`create",1,,"Let SCTP create logs"
before,0,0,q,sctpHandle(`.stplg.init;testlogdb),1,,"Switch test stplog directory"
before,0,0,q,rdbHandle:gethandle[`rdb1],1,,"Get RDB handle"
before,0,0,q,rdbHandle"endofday:{[x;y] .tst.eod:1b}",1,,"Overwrite RDB endofday function"
before,0,0,q,meta1:sctpHandle".stpm.metatable",1,,"Get initial meta table"
before,0,0,q,tcount:count sctpHandle".stpps.t",1,,"Get table count"
before,0,0,q,adj:sctpHandle".eodtime.dailyadj",1,,"Get time adjustment"
before,0,0,q,eod1:sctpHandle".eodtime.d",1,,"Get initial date"
before,0,0,q,dir1:sctpHandle".stplg.dldir",1,,"Get initial log directory"
run,0,0,q,now:.z.p,1,,"Get current time"
run,0,0,q,stpHandle(`.stplg.endofday;now;0),1,,"Run EoD function on STP"
true,0,0,q,all 0 = sctpHandle"count each `. .stpps.t",1,,"Check tables have been flushed"
run,0,0,q,meta2:get .Q.dd[dir1;`stpmeta],1,,"Get meta table from disk"
run,0,0,q,eod2:sctpHandle".eodtime.d",1,,"Get new date"
run,0,0,q,dir2:sctpHandle".stplg.dldir",1,,"Get new log directory"
true,0,0,q,rdbHandle".tst.eod",1,,"Check EoD was triggered on the sub"
true,0,0,q,(eod1+1)~eod2:sctpHandle".eodtime.d",1,,"Check EoD date has incremented"
true,0,0,q,(neg[tcount]_meta1)~(neg[tcount]_meta2),1,,"Check only the last few meta rows have been altered during the procedure"
true,0,0,q,all 00:00:00:10>(exec neg[tcount]#end from meta2)-(now+adj),1,,"Check meta rows have been filled in as expected"
true,0,0,q,eod2~eod1+1,1,,"Check the internal date has incremented"
true,0,0,q,all not null exec handle from sctpHandle"currlog",1,,"Check no null handles"
run,0,0,q,kill9proc["stp1"],1,,"STP dies"
true,0,0,q,deadproccheck["segmentedtickerplant";"stp1"],1,,"Check STP is dead"
true,0,0,q,deadproccheck["segmentedchainedtickerplant";"sctp1"],1,,"Check SCTP also dies"
after,0,0,q,"system ""rm -rf "",1_string dir2",1,,"Delete newly created log directory"