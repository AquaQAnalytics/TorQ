action,ms,bytes,lang,code,repeat,minver,comment
beforeany,0,0,q,system "sleep 1",1,,"Wait for all procs to go up"
before,0,0,q,.servers.startup[],1,,"Get connection management set up"
before,0,0,q,tpHandle:gethandle[`tp1],1,,"Get TP handle"
before,0,0,q,rdbHandles:`all`sym!gethandle each `rdball`rdbsymfilt,1,,"Get RDB handles"
run,0,0,q,t1:@[;"count trade"] each value rdbHandles,1,,"Get initial count of all trade tables"
run,0,0,q,q1:@[;"count quote"] each value rdbHandles,1,,"Get initial count of all quote tables"
run,0,0,q,tpHandle(`.u.upd;`trade;testtrade),1,,"Send test trade and quote updates to TP"
run,0,0,q,tpHandle(`.u.upd;`quote;testquote),1,,"Send test trade and quote updates to TP"
run,0,0,q,system "sleep 1",1,,"Wait to make sure values are published"
true,0,0,q,(t1+10 5)~t2:@[;"count trade"] each value rdbHandles,1,,"Check correct trade values are published"
true,0,0,q,(q1+10 0)~q2:@[;"count quote"] each value rdbHandles,1,,"Check correct quote values are published"
run,0,0,q,kill9proc each string `rdball`rdbsymfilt,1,,"Kill all RDBs"
true,0,0,q,all not isalive each string `rdball`rdbsymfilt,1,,"Make sure they are dead"
run,0,0,q,startproc each string `rdball`rdbsymfilt,1,,"Start all RDBs"
run,0,0,q,.z.pc each value rdbHandles,1,,"Force reconnection"
run,0,0,q,system "sleep 1",1,,"Give them time to start"
true,0,0,q,all isalive each string `rdball`rdbsymfilt,1,,"Make sure they are up"
run,0,0,q,rdbHandles:`all`sym!gethandle each `rdball`rdbsymfilt,1,,"Get RDB handles"
true,0,0,q,t2~@[;"count trade"] each value rdbHandles,1,,"Check correct trade values are replayed"
true,0,0,q,q2~@[;"count quote"] each value rdbHandles,1,,"Check correct quote values are replayed"