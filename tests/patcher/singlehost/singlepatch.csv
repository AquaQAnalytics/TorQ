action,ms,bytes,lang,code,repeat,minver,comment
beforeany,0,0,q,system "sleep 5",1,,"Wait for all procs to go up"
before,0,0,q,.servers.startup[],1,,"Get connection management set up"
before,0,0,q,system "sleep 2",1,,"Wait for all connections"
before,0,0,q,stpHandle:gethandle[`stp1],1,,"Get STP handle"
before,0,0,q,rdbHandle:gethandle[`rdb1],1,,"Get RDB handle"
before,0,0,q,patcherHandle:gethandle[`patcher1],1,,"Get patcher handle"
run,0,0,q,patcherHandle (set;`.patch.versiontab;testversiontable),1,,"Change on disk verison tab"
run,0,0,q,test1: get testversiontable,1,,"Read in initial version tab"
run,0,0,q,patcherHandle (`applypatch;`proctype;`rdb;`.t1.test;{1+1}),1,,"Patch rdb only"
true,0,0,q,{1+1}~rdbHandle".t1.test",1,,"Check single patch is applied to rdb"
run,0,0,q,test2: get testversiontable,1,,"Read in new version tab"
true,0,0,q,"{1+1}~last exec newversion from test2 where procname=`rdb1,function=`.t1.test",1,,"Check lastest version of .t1.test"
run,0,0,q,patcherHandle (`applypatch;`;`;`.t1.test;{1+2}),1,,"Patch rdb only"
run,0,0,q,versiontime: patcherHandle"last exec time from functionversion where procname=`rdb1",1,,"Store timestamp of patch"
true,0,0,q,{1+2}~rdbHandle".t1.test",1,,"Check patch is applied to rdb"
true,0,0,q,{1+2}~stpHandle".t1.test",1,,"Check patch is applied to stp"
run,0,0,q,test2: get testversiontable,1,,"Read in new version tab"
true,0,0,q,"{1+2}~last exec newversion from test2 where procname=`rdb1,function=`.t1.test",1,,"Check lastest version of .t1.test"
true,0,0,q,"{1+2}~last exec newversion from test2 where procname=`rdb1,function=`.t1.test",1,,"Check lastest version of .t1.test"
run,0,0,q,patcherHandle (`applypatch;`proctype;`rdb;`.t1.test;`test1),1,,"Patch rdb again"
true,0,0,q,`test1~rdbHandle".t1.test",1,,"Check repatch successful"
run,0,0,q,patcherHandle (`rollback;`rdb1;`.t1.test;versiontime),1,,"Rollback to run"
true,0,0,q,{1+1}~rdbHandle".t1.test",1,,"Check rollback successful"
after,0,0,q,"system ""rm "",1_string testversiontable",1,,"Delete test version tab"
